select * from user_data

-- BOXPLOT
WITH CTE AS (
SELECT Q1-1.5*IQR AS MIN, 
Q3+1.5*IQR AS MAX
FROM (
SELECT 
PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY USERS) AS Q1,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY USERS) AS Q3,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY USERS) - PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY USERS) AS IQR
FROM USER_DATA)
	 AS A)

-- XÁC ĐỊNH OUTLIER
SELECT * FROM
USER_DATA
WHERE USERS < (SELECT MIN FROM CTE)
OR  USERS > (SELECT MAX FROM CTE)


--- Z-SCORE
SELECT AVG(USERS), STDDEV(USERS),
FROM USER_DATA

WITH CTE1 AS (
SELECT DATA_DATE,
USERS, 
(SELECT AVG(USERS) FROM USER_DATA) AS AVG,
(SELECT STDDEV(USERS) FROM USER_DATA) AS STD
FROM USER_DATA ),
CTE2 AS (
SELECT DATA_DATE, USERS, (USERS-AVG)/STD AS Z_SCORE
FROM CTE1
WHERE ABS((USERS-AVG)/STD) > 2)

UPDATE USER_DATA
SET USERS = (SELECT AVG(USERS) FROM USER_DATA)
WHERE USERS IN (SELECT USERS FROM CTE2)




